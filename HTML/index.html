<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>HTTP Admin</title>
		<link rel="stylesheet" type="text/css" href="css/main.css">

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<script src="js/dedi.js"></script>
		<script src="js/hub.js"></script>
	
<script>
var serverType = "";

$( document ).ready(function() {
    console.log( "ready!" );
	
	// Get the server type
	getServerType();
	
	// Do we have a valid server type?
	if (serverType != "" && serverType != "unknown")
	{
		// Load the summary page
		loadPage("summary.html");
		
		// Load the menu
		loadMenu();
	} else {
		// Not a valid server type, display errors
		$("#nav").html("");
		$("#content").html("Error: Unkown server type");
	}
});

/*
Gets the current server type
*/
function getServerType()
{
	// TODO set a cookie which caches serverType, only request from server after a hour
	$.ajax({
		url: "request.json",
		type: "GET",
		cache: false,
		async: false,
		timeout: 1000000,
		success: function(msg){ 
            serverType = msg.servType.toLowerCase();
		}
	});
}

/*
Loads a given page within the server type folder
if dirRoot is true the given page will be loaded from the directory root
*/
function loadPage(page, dirRoot)
{
	if (dirRoot === undefined) {
		dirRoot = false;
    }

	var fullPath;
	if (dirRoot)
		fullPath = page;
	else
		fullPath = serverType+"/"+page;
	
	$("#content").load(fullPath, function(responseTxt, statusTxt, xhr){
		//if (statusTxt == "error")
			//alert("Error: unable to load "+ fullPath);
	});
}

/*
Loads the server type menu
*/
function loadMenu()
{
	$("#menu").load(serverType+"/menu.html", function(responseTxt, statusTxt, xhr){
		if (statusTxt == "error")
			alert("Error: unable to load "+ serverType+"/"+page);			
	});

}



</script>
	
<script>
function handleResponse(json)
{
	//console.log("Type: "+json['servType']);
	
	if (json.response)
	{
		console.log("Response from server");
		for (var i = 0; i < json.response.length; i++)
		{
			var response = json.response[i];
			console.log("For: "+response.name);
			
			var functionName = 'process' + json.servType.slice(0,1).toUpperCase() + json.servType.slice(1);
			functionName += response.name.slice(0,1).toUpperCase() + response.name.slice(1);
			
			try 
			{
				window[functionName](response.data);
			} catch(err) {
				console.log("Unable to find or error with function "+ functionName +" Error:"+ err);
			}
		}
	}
}

function processDediServerInfo(data)
{
	document.getElementById('serverName').innerHTML = data.serverName;
	document.getElementById('serverMOTD').innerHTML = data.motd;
	document.getElementById('gameMode').innerHTML = data.gameMode;
	//document.getElementById('mapRotation').innerHTML = data.mapRotation;
	
	//	document.getElementById('maxPlayers').innerHTML = '';
	//	document.getElementById('maxSpectators').innerHTML = '';
	console.log("Done processDediServerInfo");
	return true;
}

function processDediMatchInfo(data)
{
	document.getElementById('mapName').innerHTML = data.map;
	document.getElementById('timeLimit').innerHTML = timeConvert(data.timeLimit);
	document.getElementById('timeRemaining').innerHTML = timeConvert(data.timeRemaining);
	// teamGame
	document.getElementById('matchState').innerHTML = data.state;
	// hasStarted
	// inProgress
	document.getElementById('goalScore').innerHTML = data.goalScore;
	// minPlayersToStart
	

	//document.getElementById('playerCount').innerHTML = '';
	//document.getElementById('spectatorCount').innerHTML = '';
	
	
	console.log("Done processDediMatchInfo");
	return true;
}

function processDediPlayers(data)
{
/*
	var html = "<h2>Players</h2>";
	
	html += "<table><tr><th>Name</th><th>Score</th><th>Kills</th><th>Deaths</th><th>Kick?</th><th>Ban?</th></tr>";
		
	for (Player in playersJson)
	{
		var PlayerData = playersJson[Player];
		html += "<tr>";
		html += "<td><a alt=\""+ PlayerData.id +"\">" + PlayerData.name + "</a></td>";
		html += "<td>" + PlayerData.score + "</td>";
		html += "<td>" + PlayerData.kills + "</td>";
		html += "<td>" + PlayerData.deaths + "</td>";

		if (PlayerData.bot == 0)
		{
			html += "<td></td>";
			html += "<td></td>";
		}
		else
		{
			html += "<td><a herf=\"#\" onclick=\"actionPlayerKick('"+ (PlayerData.id? PlayerData.id : PlayerData.name) +"')\">Kick</a></td>";
			html += "<td><a herf=\"#\" onclick=\"actionPlayerBan('"+ (PlayerData.id? PlayerData.id : PlayerData.name) +"')\">Ban</a></td>";
		}
		html +="</tr>";
	}
		
	html += "</table>";	
	
	
	return html;
*/
	console.log("Done processDediPlayers");
	return true;
}

function request()
{
	var dataString = '{"request":[{"name":"serverInfo"},{"name":"matchInfo"},{"name":"players", "data":{"sort":"DESC"}}]}';
	
		$.ajax({
			type: "post",
			url: "http://localhost:8082/request.json",
			data: dataString,
			cache: false,
			success: function(data) {
				handleResponse(data);
			}
		});		
}

function requestServerInfo()
{
	var dataString = '{"request":[{"name":"serverInfo"}]}';
	
		$.ajax({
			type: "post",
			url: "http://localhost:8082/request.json",
			data: dataString,
			cache: false,
			success: function(data) {
				document.getElementById('msg').innerHTML = data;
			}
		});		
}

function requestMatchInfo()
{
	var dataString = '{"request":[{"name":"matchInfo"}]}';
	
		$.ajax({
			type: "post",
			url: "http://localhost:8082/request.json",
			data: dataString,
			cache: false,
			success: function(data) {
				document.getElementById('msg').innerHTML = data;
			}
		});		
}

function requestPlayers()
{
	var dataString = '{"request":[{"name":"players"}]}';
	
		$.ajax({
			type: "post",
			url: "http://localhost:8082/request.json",
			data: dataString,
			cache: false,
			success: function(data) {
				document.getElementById('msg').innerHTML = data;
			}
		});		
}

function timeConvert(seconds)
{
	var date = new Date(1970,0,1);
    date.setSeconds(seconds);
    return date.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/, "$1");
}

//setInterval(request, 2000);
//request();
</script>

	</head>
	
	<body>
		<div id="wrapper">
		
			<main>
				<div id="msg"></div>
					
				<div id="content" class="innertube">
				</div>
			</main>
			
			<nav id="nav">
				<div class="innertube">
					<h3>Main</h3>
					<ul>
						<li><a href="#">Console</a></li>
						<li><a href="#">Access Policy</a></li>
						<li><a href="#">Logout</a></li>
					</ul>
				</div>					
				<div id="menu" class="innertube">

									
				</div>
			</nav>
			
		</div>
	</body>
</html>